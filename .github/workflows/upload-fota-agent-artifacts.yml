name: Upload FotaAgent and Dependencies Artifacts

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - copilot/list-apps-dependencies
    paths:
      - 'system/system/priv-app/FotaAgent/**'
      - 'system/system/priv-app/OmaCP/**'
      - 'system/system/priv-app/AppUpdateCenter/**'
      - 'system/system/priv-app/MCFDeviceSync/**'
      - 'system/system/priv-app/NSDSWebApp/**'
      - 'system/system/priv-app/SmartSwitchAssistant/**'
      - 'system/system/priv-app/AuthFramework/**'
      - 'system/system/priv-app/CIDManager/**'
      - 'system/system/priv-app/SPPPushClient/**'
      - 'system/system/priv-app/Knox*/**'
      - 'system/system/priv-app/knox*/**'
      - 'system/system/priv-app/SKMSAgent/**'
      - 'system/system/priv-app/SCPMAgent/**'
      - 'system/system/priv-app/SVCAgent/**'
      - 'system/system/priv-app/SOAgent*/**'
      - 'system/system/priv-app/KLMSAgent/**'
      - 'system/system/priv-app/OMCAgent*/**'
      - 'system/system/priv-app/DiagMonAgent*/**'
      - 'system/system/priv-app/DeviceQualityAgent*/**'
      - 'system/system/priv-app/EnhancedAttestationAgent/**'
      - 'system/system/priv-app/SamsungSeAgent/**'
      - 'system/system/priv-app/SamsungCoreServices/**'
      - 'system/system/priv-app/SamsungAccount/**'
      - 'system/system/priv-app/SamsungPass/**'
      - 'system/system/app/MDMApp/**'
      - 'system/system/app/UniversalMDMClient/**'
      - 'system/system/framework/telephony-common.jar'
      - 'system/system/framework/telephony-ext.jar'
      - 'system/system/framework/framework.jar'
      - 'system/system/framework/services.jar'
      - 'system/system/framework/ims-common.jar'
      - 'system/system/framework/imsmanager.jar'
      - 'system/system/framework/FabricCryptoLib.jar'
      - 'system/system/framework/PQCKeystoreProvider.jar'
      - 'system/system/framework/SecureKeyBlob.jar'
      - 'system/system/framework/samsungkeystoreutils.jar'
      - 'system/system/framework/service-samsung-payment.jar'
      - 'system/system/framework/service-samsung-blockchain.jar'
      - 'system/system/framework/incident-helper-cmd.jar'
      - 'system/system/framework/ext.jar'
      - 'product/overlay/**/framework-res__dm2q*.apk'
      - 'vendor/overlay/**/Tethering*.apk'
      - 'vendor/overlay/**/Connectivity*.apk'
      - 'vendor/overlay/**/framework-res*.apk'
      - 'system/system/lib/libadbd_auth.so'
      - 'system/system/lib/libaccauthentication_jni.so'
      - 'system/system/lib/libauthentication_jni.so'
      - 'system/system/lib/libedmnativehelper.so'
      - 'system/system/lib/libedmnativehelperservice.so'
      - 'system/system/lib/android.hardware.security.keymint-V2-ndk.so'
      - 'system/system/lib/android.security.authorization-ndk.so'
      - 'system/system/lib/android.system.keystore2-V5-ndk.so'
      - 'system/system/lib/libdk_native_keymint.so'
      - 'system/system/lib/libtlc_blockchain_keystore.so'
      - 'system/system/lib/vendor.samsung.hardware.keymint-V2-ndk.so'
      - 'system/system/lib/vendor.samsung.hardware.security.*.so'
      - 'system/system/lib/vendor.samsung.hardware.tlc.hdm@*.so'
      - 'system/system/lib64/libadbd_auth.so'
      - 'system/system/lib64/libaccauthentication_jni.so'
      - 'system/system/lib64/libauthentication_jni.so'
      - 'system/system/lib64/libedmnativehelper.so'
      - 'system/system/lib64/libedmnativehelperservice.so'
      - 'system/system/lib64/android.hardware.security.keymint-*.so'
      - 'system/system/lib64/android.security.authorization-ndk.so'
      - 'system/system/lib64/android.system.keystore2-V5-ndk.so'
      - 'system/system/lib64/libdk_native_keymint.so'
      - 'system/system/lib64/libtlc_blockchain_keystore.so'
      - 'system/system/lib64/vendor.samsung.hardware.keymint-V2-ndk.so'
      - 'system/system/lib64/vendor.samsung.hardware.security.*.so'
      - 'system/system/lib64/vendor.samsung.hardware.tlc.hdm@*.so'
      - 'system/system/lib64/android.hardware.keymaster@*.so'
      - 'vendor/lib/libmdmdetect.so'
      - 'vendor/lib/libfidoauthnr_v2.so'
      - 'vendor/lib/vendor.samsung.hardware.authfw@1.0.so'
      - 'vendor/lib64/libmdmdetect.so'
      - 'vendor/lib64/libmdmimgload.so'
      - 'vendor/lib64/libfidoauthnr_v2.so'
      - 'vendor/lib64/vendor.samsung.hardware.authfw@1.0.so'
  pull_request:
    paths:
      - 'system/system/priv-app/FotaAgent/**'
      - 'system/system/priv-app/OmaCP/**'
      - 'system/system/priv-app/AppUpdateCenter/**'
      - 'system/system/priv-app/MCFDeviceSync/**'
      - 'system/system/priv-app/NSDSWebApp/**'
      - 'system/system/priv-app/SmartSwitchAssistant/**'
      - 'system/system/priv-app/AuthFramework/**'
      - 'system/system/priv-app/CIDManager/**'
      - 'system/system/priv-app/SPPPushClient/**'
      - 'system/system/app/MDMApp/**'
      - 'system/system/app/UniversalMDMClient/**'
      - 'system/system/framework/telephony-common.jar'
      - 'system/system/framework/telephony-ext.jar'
      - 'system/system/framework/framework.jar'
      - 'system/system/framework/services.jar'
      - 'system/system/framework/ims-common.jar'
      - 'system/system/framework/imsmanager.jar'
      - 'system/system/framework/FabricCryptoLib.jar'
      - 'system/system/framework/PQCKeystoreProvider.jar'
      - 'system/system/framework/SecureKeyBlob.jar'
      - 'system/system/framework/samsungkeystoreutils.jar'
      - 'system/system/framework/service-samsung-payment.jar'
      - 'system/system/framework/service-samsung-blockchain.jar'
      - 'system/system/framework/incident-helper-cmd.jar'
      - 'system/system/framework/ext.jar'
      - 'product/overlay/**/framework-res__dm2q*.apk'
      - 'vendor/overlay/**/Tethering*.apk'
      - 'vendor/overlay/**/Connectivity*.apk'
      - 'vendor/overlay/**/framework-res*.apk'
      - 'system/system/lib/libadbd_auth.so'
      - 'system/system/lib/libaccauthentication_jni.so'
      - 'system/system/lib/libauthentication_jni.so'
      - 'system/system/lib/libedmnativehelper.so'
      - 'system/system/lib/libedmnativehelperservice.so'
      - 'system/system/lib/android.hardware.security.keymint-V2-ndk.so'
      - 'system/system/lib/android.security.authorization-ndk.so'
      - 'system/system/lib/android.system.keystore2-V5-ndk.so'
      - 'system/system/lib/libdk_native_keymint.so'
      - 'system/system/lib/libtlc_blockchain_keystore.so'
      - 'system/system/lib/vendor.samsung.hardware.keymint-V2-ndk.so'
      - 'system/system/lib/vendor.samsung.hardware.security.*.so'
      - 'system/system/lib/vendor.samsung.hardware.tlc.hdm@*.so'
      - 'system/system/lib64/libadbd_auth.so'
      - 'system/system/lib64/libaccauthentication_jni.so'
      - 'system/system/lib64/libauthentication_jni.so'
      - 'system/system/lib64/libedmnativehelper.so'
      - 'system/system/lib64/libedmnativehelperservice.so'
      - 'system/system/lib64/android.hardware.security.keymint-*.so'
      - 'system/system/lib64/android.security.authorization-ndk.so'
      - 'system/system/lib64/android.system.keystore2-V5-ndk.so'
      - 'system/system/lib64/libdk_native_keymint.so'
      - 'system/system/lib64/libtlc_blockchain_keystore.so'
      - 'system/system/lib64/vendor.samsung.hardware.keymint-V2-ndk.so'
      - 'system/system/lib64/vendor.samsung.hardware.security.*.so'
      - 'system/system/lib64/vendor.samsung.hardware.tlc.hdm@*.so'
      - 'system/system/lib64/android.hardware.keymaster@*.so'
      - 'vendor/lib/libmdmdetect.so'
      - 'vendor/lib/libfidoauthnr_v2.so'
      - 'vendor/lib/vendor.samsung.hardware.authfw@1.0.so'
      - 'vendor/lib64/libmdmdetect.so'
      - 'vendor/lib64/libmdmimgload.so'
      - 'vendor/lib64/libfidoauthnr_v2.so'
      - 'vendor/lib64/vendor.samsung.hardware.authfw@1.0.so'

jobs:
  collect-and-upload-fota-artifacts:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create artifact directory structure
        run: |
          mkdir -p artifact_output/system/system/priv-app
          mkdir -p artifact_output/system/system/app
          mkdir -p artifact_output/system/system/etc/permissions
          mkdir -p artifact_output/system/system/etc/default-permissions
          mkdir -p artifact_output/system/system/framework
          mkdir -p artifact_output/system/system/lib
          mkdir -p artifact_output/system/system/lib64
          mkdir -p artifact_output/vendor/lib
          mkdir -p artifact_output/vendor/lib64
          mkdir -p artifact_output/vendor/overlay
          mkdir -p artifact_output/product/overlay
          mkdir -p artifact_output/docs

      - name: Copy FotaAgent application
        run: |
          echo "Copying FotaAgent (APK only, excluding odex/vdex)..."
          if [ -d "system/system/priv-app/FotaAgent" ]; then
            mkdir -p artifact_output/system/system/priv-app/FotaAgent
            find system/system/priv-app/FotaAgent -name "*.apk" -exec cp {} artifact_output/system/system/priv-app/FotaAgent/ \;
            echo "✓ FotaAgent APK copied"
          else
            echo "⚠ FotaAgent not found"
          fi

      - name: Copy OmaCP application
        run: |
          echo "Copying OmaCP (OMA Client Provisioning, APK only)..."
          if [ -d "system/system/priv-app/OmaCP" ]; then
            mkdir -p artifact_output/system/system/priv-app/OmaCP
            find system/system/priv-app/OmaCP -name "*.apk" -exec cp {} artifact_output/system/system/priv-app/OmaCP/ \;
            echo "✓ OmaCP APK copied"
          else
            echo "⚠ OmaCP not found"
          fi

      - name: Copy AppUpdateCenter application
        run: |
          echo "Copying AppUpdateCenter (APK only)..."
          if [ -d "system/system/priv-app/AppUpdateCenter" ]; then
            mkdir -p artifact_output/system/system/priv-app/AppUpdateCenter
            find system/system/priv-app/AppUpdateCenter -name "*.apk" -exec cp {} artifact_output/system/system/priv-app/AppUpdateCenter/ \;
            echo "✓ AppUpdateCenter APK copied"
          else
            echo "⚠ AppUpdateCenter not found"
          fi

      - name: Copy MCFDeviceSync application
        run: |
          echo "Copying MCFDeviceSync (Multi-Connect Framework, APK only)..."
          if [ -d "system/system/priv-app/MCFDeviceSync" ]; then
            mkdir -p artifact_output/system/system/priv-app/MCFDeviceSync
            find system/system/priv-app/MCFDeviceSync -name "*.apk" -exec cp {} artifact_output/system/system/priv-app/MCFDeviceSync/ \;
            echo "✓ MCFDeviceSync APK copied"
          else
            echo "⚠ MCFDeviceSync not found"
          fi

      - name: Copy NSDSWebApp application
        run: |
          echo "Copying NSDSWebApp (Network Service Discovery, APK only)..."
          if [ -d "system/system/priv-app/NSDSWebApp" ]; then
            mkdir -p artifact_output/system/system/priv-app/NSDSWebApp
            find system/system/priv-app/NSDSWebApp -name "*.apk" -exec cp {} artifact_output/system/system/priv-app/NSDSWebApp/ \;
            echo "✓ NSDSWebApp APK copied"
          else
            echo "⚠ NSDSWebApp not found"
          fi

      - name: Copy SmartSwitchAssistant application
        run: |
          echo "Copying SmartSwitchAssistant (APK only)..."
          if [ -d "system/system/priv-app/SmartSwitchAssistant" ]; then
            mkdir -p artifact_output/system/system/priv-app/SmartSwitchAssistant
            find system/system/priv-app/SmartSwitchAssistant -name "*.apk" -exec cp {} artifact_output/system/system/priv-app/SmartSwitchAssistant/ \;
            echo "✓ SmartSwitchAssistant APK copied"
          else
            echo "⚠ SmartSwitchAssistant not found"
          fi

      - name: Copy AuthFramework application
        run: |
          echo "Copying AuthFramework (Authentication Framework, APK only)..."
          if [ -d "system/system/priv-app/AuthFramework" ]; then
            mkdir -p artifact_output/system/system/priv-app/AuthFramework
            find system/system/priv-app/AuthFramework -name "*.apk" -exec cp {} artifact_output/system/system/priv-app/AuthFramework/ \;
            echo "✓ AuthFramework APK copied"
          else
            echo "⚠ AuthFramework not found"
          fi

      - name: Copy CIDManager application
        run: |
          echo "Copying CIDManager (Carrier ID Manager, APK only)..."
          if [ -d "system/system/priv-app/CIDManager" ]; then
            mkdir -p artifact_output/system/system/priv-app/CIDManager
            find system/system/priv-app/CIDManager -name "*.apk" -exec cp {} artifact_output/system/system/priv-app/CIDManager/ \;
            echo "✓ CIDManager APK copied"
          else
            echo "⚠ CIDManager not found"
          fi

      - name: Copy SPPPushClient application
        run: |
          echo "Copying SPPPushClient (Samsung Push Protocol, APK only)..."
          if [ -d "system/system/priv-app/SPPPushClient" ]; then
            mkdir -p artifact_output/system/system/priv-app/SPPPushClient
            find system/system/priv-app/SPPPushClient -name "*.apk" -exec cp {} artifact_output/system/system/priv-app/SPPPushClient/ \;
            echo "✓ SPPPushClient APK copied"
          else
            echo "⚠ SPPPushClient not found"
          fi

      - name: Copy MDM applications
        run: |
          echo "Copying MDM applications (APK only)..."
          # Copy MDMApp
          if [ -d "system/system/app/MDMApp" ]; then
            mkdir -p artifact_output/system/system/app/MDMApp
            find system/system/app/MDMApp -name "*.apk" -exec cp {} artifact_output/system/system/app/MDMApp/ \;
            echo "✓ MDMApp APK copied"
          else
            echo "⚠ MDMApp not found"
          fi
          
          # Copy UniversalMDMClient
          if [ -d "system/system/app/UniversalMDMClient" ]; then
            mkdir -p artifact_output/system/system/app/UniversalMDMClient
            find system/system/app/UniversalMDMClient -name "*.apk" -exec cp {} artifact_output/system/system/app/UniversalMDMClient/ \;
            echo "✓ UniversalMDMClient APK copied"
          else
            echo "⚠ UniversalMDMClient not found"
          fi

      - name: Copy Knox applications
        run: |
          echo "Copying Knox applications (APK only)..."
          # Core Knox apps
          for knox_app in \
            KnoxCore \
            KnoxGuard \
            KnoxPushManager \
            KnoxMposAgent \
            KnoxERAgent \
            KnoxZtFramework \
            KnoxNetworkFilter \
            KnoxSandbox \
            knoxanalyticsagent \
            knoxvpnproxyhandler; do
            if [ -d "system/system/priv-app/$knox_app" ]; then
              mkdir -p "artifact_output/system/system/priv-app/$knox_app"
              find "system/system/priv-app/$knox_app" -name "*.apk" -exec cp {} "artifact_output/system/system/priv-app/$knox_app/" \;
              echo "✓ $knox_app APK copied"
            fi
          done

      - name: Copy Samsung Agent applications
        run: |
          echo "Copying Samsung Agent applications (APK only)..."
          # Samsung agents for device management, security, and services
          for agent_app in \
            SKMSAgent \
            SCPMAgent \
            SVCAgent \
            SOAgent76 \
            KLMSAgent \
            OMCAgent5 \
            DiagMonAgent95 \
            DeviceQualityAgent36 \
            EnhancedAttestationAgent \
            SamsungSeAgent; do
            if [ -d "system/system/priv-app/$agent_app" ]; then
              mkdir -p "artifact_output/system/system/priv-app/$agent_app"
              find "system/system/priv-app/$agent_app" -name "*.apk" -exec cp {} "artifact_output/system/system/priv-app/$agent_app/" \;
              echo "✓ $agent_app APK copied"
            fi
          done

      - name: Copy Samsung Core Services
        run: |
          echo "Copying Samsung Core Services (APK only)..."
          # Samsung core service apps
          for core_app in \
            SamsungCoreServices \
            SamsungAccount \
            SamsungPass; do
            if [ -d "system/system/priv-app/$core_app" ]; then
              mkdir -p "artifact_output/system/system/priv-app/$core_app"
              find "system/system/priv-app/$core_app" -name "*.apk" -exec cp {} "artifact_output/system/system/priv-app/$core_app/" \;
              echo "✓ $core_app APK copied"
            fi
          done

      - name: Copy default permissions
        run: |
          echo "Skipping permission files per requirements..."
          echo "⚠ Permission XML files and default permissions not copied"

      - name: Copy related framework JARs
        run: |
          echo "Copying related framework JARs (OTA, DM, MDM, Auth, Telephony, Security)..."
          # Copy framework JARs related to FOTA, OTA, DM, MDM, authentication, security, and telephony
          for jar in \
            telephony-common.jar \
            telephony-ext.jar \
            framework.jar \
            framework-graphics.jar \
            framework-location.jar \
            framework-nfc.jar \
            framework-ondeviceintelligence-platform.jar \
            framework-platformcrashrecovery.jar \
            services.jar \
            ims-common.jar \
            imsmanager.jar \
            EpdgManager.jar \
            FabricCryptoLib.jar \
            PQCKeystoreProvider.jar \
            SecureKeyBlob.jar \
            samsungkeystoreutils.jar \
            service-samsung-payment.jar \
            service-samsung-blockchain.jar \
            incident-helper-cmd.jar \
            ext.jar \
            esecomm.jar \
            com.samsung.android.semtelephonesdk.framework-v1.jar \
            com.samsung.android.nfc.adapter.jar \
            com.samsung.device.jar \
            com.samsung.bbc.jar \
            com.sec.android.pmssdk.framework-v1.jar \
            com.sec.android.sdhmssdk.framework-v1.jar \
            com.android.future.usb.accessory.jar \
            com.android.location.provider.jar \
            android.hidl.base-V1.0-java.jar \
            android.hidl.manager-V1.0-java.jar \
            monkey.jar \
            motionrecognitionservice.jar \
            perfsdkservice.jar \
            secinputdev-service.jar \
            semcontextservice.jar \
            semuwb-service.jar \
            semwifi-service.jar \
            vendor.samsung.frameworks.codecsolution-service.jar \
            vendor.samsung.frameworks.hdrsolution-service.jar \
            vexfwk_service_lib.jar \
            QPerformance.jar \
            QXPerformance.jar \
            UxPerformance.jar \
            SmpsManager.jar; do
            if [ -f "system/system/framework/$jar" ]; then
              cp "system/system/framework/$jar" artifact_output/system/system/framework/
              echo "✓ $jar copied"
            fi
          done

      - name: Copy authentication libraries (lib)
        run: |
          echo "Copying authentication libraries from system/lib..."
          # Authentication libraries
          for lib in libadbd_auth.so libaccauthentication_jni.so libauthentication_jni.so libedmnativehelper.so libedmnativehelperservice.so; do
            if [ -f "system/system/lib/$lib" ]; then
              cp "system/system/lib/$lib" artifact_output/system/system/lib/
              echo "✓ $lib copied"
            fi
          done

      - name: Copy authentication libraries (lib64)
        run: |
          echo "Copying authentication libraries from system/lib64..."
          # Authentication libraries
          for lib in libadbd_auth.so libaccauthentication_jni.so libauthentication_jni.so libedmnativehelper.so libedmnativehelperservice.so; do
            if [ -f "system/system/lib64/$lib" ]; then
              cp "system/system/lib64/$lib" artifact_output/system/system/lib64/
              echo "✓ $lib (64-bit) copied"
            fi
          done

      - name: Copy security and keystore libraries (lib)
        run: |
          echo "Copying security and keystore libraries from system/lib..."
          # Security and keystore libraries
          for lib in android.hardware.security.keymint-V2-ndk.so android.security.authorization-ndk.so android.system.keystore2-V5-ndk.so libdk_native_keymint.so libtlc_blockchain_keystore.so libkeyutils.so vendor.samsung.hardware.keymint-V2-ndk.so vendor.samsung.hardware.security.wsm.service-V1-ndk.so vendor.samsung.hardware.security.skpm-V1-ndk.so vendor.samsung.hardware.tlc.hdm@1.0.so vendor.samsung.hardware.tlc.hdm@1.1.so vendor.samsung.hardware.tlc.hdm@1.2.so; do
            if [ -f "system/system/lib/$lib" ]; then
              cp "system/system/lib/$lib" artifact_output/system/system/lib/
              echo "✓ $lib copied"
            fi
          done

      - name: Copy security and keystore libraries (lib64)
        run: |
          echo "Copying security and keystore libraries from system/lib64..."
          # Security and keystore libraries
          for lib in android.hardware.security.keymint-V2-ndk.so android.hardware.security.keymint-V4-ndk.so android.security.authorization-ndk.so android.security.securekeygeneration-ndk.so android.system.keystore2-V5-ndk.so libdk_native_keymint.so libtlc_blockchain_keystore.so libkeyutils.so vendor.samsung.hardware.keymint-V2-ndk.so vendor.samsung.hardware.security.wsm.service-V1-ndk.so vendor.samsung.hardware.security.skpm-V1-ndk.so vendor.samsung.hardware.tlc.hdm@1.0.so vendor.samsung.hardware.tlc.hdm@1.1.so vendor.samsung.hardware.tlc.hdm@1.2.so android.hardware.keymaster@3.0.so android.hardware.keymaster@4.0.so android.hardware.keymaster@4.1.so; do
            if [ -f "system/system/lib64/$lib" ]; then
              cp "system/system/lib64/$lib" artifact_output/system/system/lib64/
              echo "✓ $lib (64-bit) copied"
            fi
          done

      - name: Copy MDM and FIDO libraries from vendor (lib)
        run: |
          echo "Copying MDM and FIDO libraries from vendor/lib..."
          # MDM and authentication libraries from vendor
          for lib in libmdmdetect.so libfidoauthnr_v2.so vendor.samsung.hardware.authfw@1.0.so; do
            if [ -f "vendor/lib/$lib" ]; then
              cp "vendor/lib/$lib" artifact_output/vendor/lib/
              echo "✓ $lib copied"
            fi
          done

      - name: Copy MDM and FIDO libraries from vendor (lib64)
        run: |
          echo "Copying MDM and FIDO libraries from vendor/lib64..."
          # MDM and authentication libraries from vendor
          for lib in libmdmdetect.so libmdmimgload.so libfidoauthnr_v2.so vendor.samsung.hardware.authfw@1.0.so; do
            if [ -f "vendor/lib64/$lib" ]; then
              cp "vendor/lib64/$lib" artifact_output/vendor/lib64/
              echo "✓ $lib (64-bit) copied"
            fi
          done

      - name: Copy product overlay APKs
        run: |
          echo "Copying product overlay APKs related to DM/MDM/FOTA..."
          if [ -d "product/overlay" ]; then
            # Copy dm2q specific overlay
            find product/overlay -type f -name "*dm2q*.apk" -exec sh -c 'mkdir -p "artifact_output/$(dirname "{}")" && cp "{}" "artifact_output/{}"' \;
            echo "✓ DM2Q overlay APKs copied"
          else
            echo "⚠ Product overlay directory not found"
          fi

      - name: Copy vendor overlay APKs
        run: |
          echo "Copying vendor overlay APKs related to connectivity/tethering..."
          if [ -d "vendor/overlay" ]; then
            # Copy connectivity and tethering overlays (used by MDM/FOTA)
            find vendor/overlay -type f \( -name "*Tethering*.apk" -o -name "*Connectivity*.apk" -o -name "framework-res*.apk" \) -exec sh -c 'mkdir -p "artifact_output/$(dirname "{}")" && cp "{}" "artifact_output/{}"' \;
            echo "✓ Vendor connectivity overlay APKs copied"
          else
            echo "⚠ Vendor overlay directory not found"
          fi

      - name: Create documentation
        run: |
          echo "Creating documentation..."
          cat > artifact_output/docs/FOTA_AGENT_DEPENDENCIES.md << 'EOF'
          # FotaAgent Dependencies
          
          Este documento lista todas las dependencias para FotaAgent (Firmware Over-The-Air Agent).
          
          ## Información de FotaAgent
          
          - **Ubicación**: `/system/priv-app/FotaAgent/FotaAgent.apk`
          - **Paquete**: `com.wsomacp`
          - **Tipo**: Aplicación privilegiada del sistema
          - **Función**: Gestión de actualizaciones de firmware OTA
          
          ## Archivos de la Aplicación
          
          ### FotaAgent
          - `/system/priv-app/FotaAgent/FotaAgent.apk` - APK principal
          - `/system/priv-app/FotaAgent/oat/arm64/FotaAgent.odex` - Código optimizado
          - `/system/priv-app/FotaAgent/oat/arm64/FotaAgent.vdex` - Datos de verificación
          
          ### OmaCP (OMA Client Provisioning)
          - `/system/priv-app/OmaCP/OmaCP.apk` - APK de provisión OMA-CP
          - `/system/priv-app/OmaCP/oat/arm64/OmaCP.odex` - Código optimizado
          - `/system/priv-app/OmaCP/oat/arm64/OmaCP.vdex` - Datos de verificación
          
          ### AppUpdateCenter
          - `/system/priv-app/AppUpdateCenter/AppUpdateCenter.apk` - Centro de actualizaciones de aplicaciones
          - `/system/priv-app/AppUpdateCenter/oat/arm64/AppUpdateCenter.odex` - Código optimizado
          - `/system/priv-app/AppUpdateCenter/oat/arm64/AppUpdateCenter.vdex` - Datos de verificación
          
          ### MCFDeviceSync (Multi-Connect Framework)
          - `/system/priv-app/MCFDeviceSync/MCFDeviceSync.apk` - Sincronización de dispositivos MCF
          - `/system/priv-app/MCFDeviceSync/oat/arm64/MCFDeviceSync.odex` - Código optimizado
          - `/system/priv-app/MCFDeviceSync/oat/arm64/MCFDeviceSync.vdex` - Datos de verificación
          
          ### NSDSWebApp (Network Service Discovery)
          - `/system/priv-app/NSDSWebApp/NSDSWebApp.apk` - Descubrimiento de servicios de red
          - `/system/priv-app/NSDSWebApp/oat/arm64/NSDSWebApp.odex` - Código optimizado
          - `/system/priv-app/NSDSWebApp/oat/arm64/NSDSWebApp.vdex` - Datos de verificación
          
          ### SmartSwitchAssistant
          - `/system/priv-app/SmartSwitchAssistant/SmartSwitchAssistant.apk` - Asistente de Smart Switch
          - `/system/priv-app/SmartSwitchAssistant/oat/arm64/SmartSwitchAssistant.odex` - Código optimizado
          - `/system/priv-app/SmartSwitchAssistant/oat/arm64/SmartSwitchAssistant.vdex` - Datos de verificación
          
          ### AuthFramework
          - `/system/priv-app/AuthFramework/AuthFramework.apk` - Framework de autenticación Samsung
          - `/system/priv-app/AuthFramework/oat/arm64/AuthFramework.odex` - Código optimizado
          - `/system/priv-app/AuthFramework/oat/arm64/AuthFramework.vdex` - Datos de verificación
          
          ### CIDManager (Carrier ID Manager)
          - `/system/priv-app/CIDManager/CIDManager.apk` - Gestor de identificación de operador
          - `/system/priv-app/CIDManager/oat/arm64/CIDManager.odex` - Código optimizado
          - `/system/priv-app/CIDManager/oat/arm64/CIDManager.vdex` - Datos de verificación
          
          ### SPPPushClient (Samsung Push Protocol)
          - `/system/priv-app/SPPPushClient/SPPPushClient.apk` - Cliente de protocolo push Samsung
          - `/system/priv-app/SPPPushClient/oat/arm64/SPPPushClient.odex` - Código optimizado
          - `/system/priv-app/SPPPushClient/oat/arm64/SPPPushClient.vdex` - Datos de verificación
          
          ### MDMApp (Mobile Device Management)
          - `/system/app/MDMApp/MDMApp.apk` - Aplicación de gestión de dispositivos móviles
          - `/system/app/MDMApp/oat/arm64/MDMApp.odex` - Código optimizado
          - `/system/app/MDMApp/oat/arm64/MDMApp.vdex` - Datos de verificación
          
          ### UniversalMDMClient
          - `/system/app/UniversalMDMClient/UniversalMDMClient.apk` - Cliente MDM universal
          - `/system/app/UniversalMDMClient/oat/arm64/UniversalMDMClient.odex` - Código optimizado
          - `/system/app/UniversalMDMClient/oat/arm64/UniversalMDMClient.vdex` - Datos de verificación
          
          ## Bibliotecas Nativas de Autenticación
          
          ### Bibliotecas de Autenticación (system/lib y system/lib64)
          - `libadbd_auth.so` - Autenticación ADB (Android Debug Bridge)
          - `libaccauthentication_jni.so` - JNI de autenticación de cuentas
          - `libauthentication_jni.so` - JNI de autenticación
          - `libedmnativehelper.so` - Helper nativo de EDM (Enterprise Device Management)
          - `libedmnativehelperservice.so` - Servicio helper nativo de EDM
          
          ### Bibliotecas de Seguridad y Keystore (system/lib y system/lib64)
          - `android.hardware.security.keymint-V2-ndk.so` - KeyMint HAL v2
          - `android.hardware.security.keymint-V4-ndk.so` - KeyMint HAL v4 (solo 64-bit)
          - `android.security.authorization-ndk.so` - Autorización de seguridad Android
          - `android.security.securekeygeneration-ndk.so` - Generación segura de claves (solo 64-bit)
          - `android.system.keystore2-V5-ndk.so` - Keystore 2.0 del sistema
          - `libdk_native_keymint.so` - KeyMint nativo DK
          - `libtlc_blockchain_keystore.so` - Keystore blockchain TLC
          - `libkeyutils.so` - Utilidades de claves
          - `vendor.samsung.hardware.keymint-V2-ndk.so` - KeyMint HAL Samsung
          - `vendor.samsung.hardware.security.wsm.service-V1-ndk.so` - Servicio WSM de seguridad Samsung
          - `vendor.samsung.hardware.security.skpm-V1-ndk.so` - SKPM de seguridad Samsung
          - `vendor.samsung.hardware.tlc.hdm@1.0.so` - HDM TLC Samsung v1.0
          - `vendor.samsung.hardware.tlc.hdm@1.1.so` - HDM TLC Samsung v1.1
          - `vendor.samsung.hardware.tlc.hdm@1.2.so` - HDM TLC Samsung v1.2
          - `android.hardware.keymaster@3.0.so` - Keymaster HAL v3.0 (solo 64-bit)
          - `android.hardware.keymaster@4.0.so` - Keymaster HAL v4.0 (solo 64-bit)
          - `android.hardware.keymaster@4.1.so` - Keymaster HAL v4.1 (solo 64-bit)
          
          ### Bibliotecas MDM y FIDO del Vendor (vendor/lib y vendor/lib64)
          - `libmdmdetect.so` - Detección de MDM
          - `libmdmimgload.so` - Carga de imágenes MDM (solo 64-bit)
          - `libfidoauthnr_v2.so` - Autenticador FIDO v2
          - `vendor.samsung.hardware.authfw@1.0.so` - Framework de autenticación hardware Samsung
          
          ## Framework JARs del Sistema
          
          El paquete incluye todos los archivos JAR del framework Android ubicados en `/system/framework/`.
          Esto incluye aproximadamente 104 archivos JAR que proporcionan APIs y servicios del sistema, incluyendo:
          
          - `framework.jar` - Framework principal de Android
          - `services.jar` - Servicios del sistema
          - `telephony-common.jar` - APIs de telefonía
          - `ext.jar` - Extensiones del framework
          - `mcfsdk.jar` - SDK de Multi-Connect Framework
          - `knox_mtd.jar` - Knox Mobile Threat Defense
          - Y muchos otros JARs específicos de Samsung y Android
          
          ## Overlays de Configuración
          
          ### Product Overlays (/product/overlay/)
          
          Overlays específicos del dispositivo DM2Q:
          - `framework-res__dm2qxxx__auto_generated_rro_product.apk` - Recursos del framework específicos del dispositivo
          
          ### Vendor Overlays (/vendor/overlay/)
          
          Overlays de conectividad y tethering necesarios para MDM y FOTA:
          - `TetheringOverlay.apk` - Configuración de tethering
          - `TetheringOverlay_Gsi.apk` - Configuración de tethering GSI
          - `ConnectivityOverlay.apk` - Configuración de conectividad
          - `framework-res__auto_generated_rro_vendor.apk` - Recursos del framework del vendor
          
          Estos overlays son críticos para la gestión de conexiones de red utilizadas por:
          - Actualizaciones OTA (descarga de firmware)
          - Gestión remota de dispositivos (MDM)
          - Comunicación con servidores de actualización
          
          ## Permisos XML
          
          ### privapp-permissions-com.wsomacp.xml
          Permisos privilegiados para FotaAgent:
          - `android.permission.READ_PRIVILEGED_PHONE_STATE` - Acceso al estado privilegiado del teléfono
          - `android.permission.REAL_GET_TASKS` - Acceso a tareas del sistema
          - `android.permission.WRITE_APN_SETTINGS` - Escritura de configuración APN
          - `com.sec.android.fotaclient.permission.FOTA` - Permiso específico de FOTA
          - `android.permission.RECEIVE_SMS` - Recepción de SMS
          - `android.permission.READ_SMS` - Lectura de SMS
          - `android.permission.RECEIVE_WAP_PUSH` - Recepción de mensajes WAP Push
          - `android.permission.RECEIVE_MMS` - Recepción de MMS
          - `android.permission.READ_CELL_BROADCASTS` - Lectura de difusiones celulares
          - `android.permission.POST_NOTIFICATIONS` - Publicación de notificaciones
          
          ### privapp-permissions-com.wssyncmldm.xml
          Permisos para SyncML DM (Device Management):
          - `android.permission.ACCESS_CACHE_FILESYSTEM` - Acceso al sistema de archivos de caché
          - `android.permission.BATTERY_STATS` - Estadísticas de batería
          - `android.permission.CHANGE_CONFIGURATION` - Cambio de configuración
          - `android.permission.CRYPT_KEEPER` - Gestor de cifrado
          - `android.permission.DELETE_CACHE_FILES` - Eliminación de archivos de caché
          - `android.permission.MODIFY_PHONE_STATE` - Modificación del estado del teléfono
          - `android.permission.REBOOT` - Reinicio del sistema
          - `android.permission.WRITE_APN_SETTINGS` - Escritura de configuración APN
          - `android.permission.WRITE_MEDIA_STORAGE` - Escritura en almacenamiento multimedia
          - `android.permission.RECOVERY` - Modo de recuperación
          - `com.samsung.android.settings.permission.ACCESS_EPISODE` - Acceso a episodios de configuración
          - `com.sec.android.fota.permission.PUSH` - Permiso de push FOTA
          - `com.sec.android.fotaclient.permission.FOTA` - Permiso de cliente FOTA
          - `com.sec.android.diagmonagent.permission.DIAGMON` - Permiso de agente de diagnóstico
          - `com.sec.android.diagmonagent.permission.PROVIDER` - Proveedor de diagnóstico
          - `com.samsung.android.security.permission.SAMSUNG_KEYSTORE_PERMISSION` - Permiso de keystore Samsung
          - `android.permission.NOTIFY_PENDING_SYSTEM_UPDATE` - Notificación de actualización del sistema pendiente
          - `android.permission.READ_PRIVILEGED_PHONE_STATE` - Lectura del estado privilegiado del teléfono
          - `android.permission.CLEAR_APP_CACHE` - Limpieza de caché de aplicaciones
          - `android.permission.ACCESS_COARSE_LOCATION` - Acceso a ubicación aproximada
          - `android.permission.POST_NOTIFICATIONS` - Publicación de notificaciones
          - `android.permission.SCHEDULE_EXACT_ALARM` - Programación de alarmas exactas
          
          ### privapp-permissions-com.samsung.android.app.updatecenter.xml
          Permisos para AppUpdateCenter:
          - `android.permission.INSTALL_PACKAGE_UPDATES` - Instalación de actualizaciones de paquetes
          - `android.permission.QUERY_ALL_PACKAGES` - Consulta de todos los paquetes
          - `android.permission.RECEIVE_BOOT_COMPLETED` - Recepción de arranque completado
          - `android.permission.INTERNET` - Acceso a internet
          - `android.permission.READ_PRIVILEGED_PHONE_STATE` - Lectura del estado privilegiado del teléfono
          - `android.permission.ACCESS_NETWORK_STATE` - Acceso al estado de red
          - `android.permission.ACCESS_WIFI_STATE` - Acceso al estado WiFi
          - `android.permission.POST_NOTIFICATIONS` - Publicación de notificaciones
          - `com.samsung.android.sdm.config.provider.READ_OMC_CONFIG` - Lectura de configuración OMC
          - `com.samsung.android.permission.SEM_APP_RESTRICTION` - Restricción de aplicaciones SEM
          
          ### privapp-permissions-com.samsung.android.smartswitchassistant.xml
          Permisos para SmartSwitchAssistant (aplicación relacionada con transferencia de datos).
          
          ### privapp-permissions-com.samsung.android.cidmanager.xml
          Permisos para CIDManager (Carrier ID Manager):
          - Gestión de identificación de operador
          - Configuración de red móvil
          - Acceso a información de SIM
          
          ### privapp-permissions-com.sec.spp.push.xml
          Permisos para SPPPushClient (Samsung Push Protocol):
          - Recepción de notificaciones push
          - Comunicación con servidores Samsung
          - Gestión de mensajes de actualización OTA
          
          ## Permisos por Defecto
          
          ### default-permissions-com.wsomacp.xml
          Permisos predeterminados otorgados en tiempo de instalación:
          - `android.permission.RECEIVE_SMS` (no fijo)
          - `android.permission.READ_SMS` (no fijo)
          - `android.permission.RECEIVE_WAP_PUSH` (no fijo)
          - `android.permission.RECEIVE_MMS` (no fijo)
          - `android.permission.READ_CELL_BROADCASTS` (no fijo)
          - `android.permission.POST_NOTIFICATIONS` (no fijo)
          
          ### default-permissions-com.sec.spp.push.xml
          Permisos predeterminados para SPPPushClient:
          - Permisos de notificación push
          - Acceso a red para comunicación con servidores
          
          ## Framework JARs del Sistema
          
          El paquete incluye aproximadamente 50 archivos JAR del framework relacionados con OTA, MDM, autenticación y seguridad:
          
          ### Core Framework
          - `framework.jar` - Framework principal de Android
          - `framework-graphics.jar` - Framework de gráficos
          - `framework-location.jar` - Framework de ubicación
          - `framework-nfc.jar` - Framework NFC
          - `framework-ondeviceintelligence-platform.jar` - Plataforma de inteligencia en dispositivo
          - `framework-platformcrashrecovery.jar` - Recuperación de fallos de plataforma
          - `services.jar` - Servicios del sistema
          - `ext.jar` - Extensiones del framework
          
          ### Telephony & IMS
          - `telephony-common.jar` - APIs de telefonía comunes
          - `telephony-ext.jar` - Extensiones de telefonía
          - `ims-common.jar` - IMS común
          - `imsmanager.jar` - Gestor IMS
          - `EpdgManager.jar` - Gestor ePDG (Enhanced Packet Data Gateway)
          - `com.samsung.android.semtelephonesdk.framework-v1.jar` - SDK de telefonía Samsung
          
          ### Security & Cryptography
          - `FabricCryptoLib.jar` - Biblioteca criptográfica Fabric
          - `PQCKeystoreProvider.jar` - Proveedor de keystore post-cuántico
          - `SecureKeyBlob.jar` - Blob de clave segura
          - `samsungkeystoreutils.jar` - Utilidades de keystore Samsung
          - `service-samsung-payment.jar` - Servicio de pago Samsung
          - `service-samsung-blockchain.jar` - Servicio blockchain Samsung
          - `esecomm.jar` - Comunicación de elemento seguro embebido
          
          ### Samsung Services & SDKs
          - `com.samsung.android.nfc.adapter.jar` - Adaptador NFC Samsung
          - `com.samsung.device.jar` - APIs de dispositivo Samsung
          - `com.samsung.bbc.jar` - BBC (Blockchain Base Core) Samsung
          - `com.sec.android.pmssdk.framework-v1.jar` - SDK PMS Samsung
          - `com.sec.android.sdhmssdk.framework-v1.jar` - SDK SDHMS Samsung
          - `semcontextservice.jar` - Servicio de contexto SEM
          - `semuwb-service.jar` - Servicio UWB SEM
          - `semwifi-service.jar` - Servicio WiFi SEM
          - `vexfwk_service_lib.jar` - Biblioteca de servicio VEX Framework
          
          ### Performance & Hardware
          - `QPerformance.jar` - Rendimiento Qualcomm
          - `QXPerformance.jar` - Rendimiento extendido Qualcomm
          - `UxPerformance.jar` - Rendimiento de experiencia de usuario
          - `SmpsManager.jar` - Gestor SMPS
          - `perfsdkservice.jar` - Servicio SDK de rendimiento
          - `motionrecognitionservice.jar` - Servicio de reconocimiento de movimiento
          - `secinputdev-service.jar` - Servicio de dispositivo de entrada seguro
          - `vendor.samsung.frameworks.codecsolution-service.jar` - Servicio de solución de códec Samsung
          - `vendor.samsung.frameworks.hdrsolution-service.jar` - Servicio de solución HDR Samsung
          
          ### Utilities & Support
          - `com.android.future.usb.accessory.jar` - Accesorio USB futuro Android
          - `com.android.location.provider.jar` - Proveedor de ubicación Android
          - `android.hidl.base-V1.0-java.jar` - Base HIDL Android
          - `android.hidl.manager-V1.0-java.jar` - Gestor HIDL Android
          - `monkey.jar` - Herramienta Monkey
          - `incident-helper-cmd.jar` - Comando helper de incidentes
          
          ## Configuración del Sistema
          
          - Listado en `/system/etc/apks_count_list.txt`
          - Listado en `/system/etc/irremovable_list.txt` (aplicación protegida contra eliminación)
          - Permisos en lista irremovible: archivos XML de permisos incluidos
          
          ## Contextos SELinux
          
          Todos los archivos tienen el contexto SELinux `u:object_r:system_file:s0` definido en `file_context-system`.
          
          ## Notas Importantes
          
          1. **Aplicación Irremovible**: FotaAgent está protegida contra la eliminación por el sistema.
          
          2. **OMA-CP y OMA-DM**: El sistema usa los estándares Open Mobile Alliance:
             - OMA-CP (Client Provisioning) para configuración de dispositivos
             - OMA-DM (Device Management) para gestión remota de dispositivos
          
          3. **Protocolo FOTA**: 
             - Usa WAP Push y SMS para notificaciones de actualización
             - Requiere permisos de red y telefonía para descargar actualizaciones
             - Necesita permisos de reinicio y recuperación para instalar actualizaciones
          
          4. **Integración con DiagMonAgent**: FotaAgent se integra con el agente de diagnóstico para reportar estado de actualizaciones.
          
          5. **Seguridad**: 
             - Requiere acceso al Samsung Keystore para verificación de firma
             - Usa permisos privilegiados para operaciones de sistema críticas
             - Todos los permisos SMS/MMS son para recibir notificaciones de actualización OTA
          
          EOF
          
          # Create README for artifact
          cat > artifact_output/README.md << 'EOF'
          # FotaAgent Artifact Package
          
          This package contains FotaAgent (Firmware Over-The-Air Agent) and all its dependencies from the UN1CA-firmware-dm2q repository.
          
          ## Contents
          
          - **system/system/priv-app/FotaAgent/** - FotaAgent application
          - **system/system/priv-app/OmaCP/** - OMA Client Provisioning application
          - **system/system/priv-app/AppUpdateCenter/** - App Update Center application
          - **system/system/priv-app/MCFDeviceSync/** - Multi-Connect Framework sync application
          - **system/system/priv-app/NSDSWebApp/** - Network Service Discovery web app
          - **system/system/priv-app/SmartSwitchAssistant/** - Smart Switch assistant application
          - **system/system/etc/permissions/** - Permission XML files
          - **system/system/etc/default-permissions/** - Default permission files
          - **system/system/framework/** - Framework JARs dependencies
          - **docs/** - Documentation
          
          ## Applications Included
          
          1. **FotaAgent** (com.wsomacp) - OTA update management
          2. **OmaCP** - OMA Client Provisioning for device configuration
          3. **AppUpdateCenter** (com.samsung.android.app.updatecenter) - Application updates management
          4. **MCFDeviceSync** - Multi-Connect Framework device synchronization
          5. **NSDSWebApp** - Network Service Discovery web application
          6. **SmartSwitchAssistant** (com.samsung.android.smartswitchassistant) - Smart Switch data transfer
          3. **AppUpdateCenter** (com.samsung.android.app.updatecenter) - App updates center
          4. **MCFDeviceSync** - Multi-Connect Framework device synchronization
          5. **NSDSWebApp** - Network Service Discovery web application
          6. **SmartSwitchAssistant** (com.samsung.android.smartswitchassistant) - Smart Switch data transfer assistant
          
          ## Key Features
          
          - Firmware Over-The-Air (FOTA) update management
          - OMA-CP/OMA-DM standards compliance
          - WAP Push and SMS notification support
          - System update installation capabilities
          - Integration with Samsung diagnostic and keystore services
          
          For detailed dependency information, see docs/FOTA_AGENT_DEPENDENCIES.md
          EOF

      - name: Generate artifact manifest
        run: |
          echo "Generating artifact manifest..."
          cd artifact_output
          find . -type f | sort > MANIFEST.txt
          echo "Total files: $(wc -l < MANIFEST.txt)"
          echo ""
          echo "=== Manifest Content ==="
          cat MANIFEST.txt

      - name: Upload FotaAgent artifact
        uses: actions/upload-artifact@v4
        with:
          name: fota-agent-dependencies-${{ github.sha }}
          path: artifact_output/
          retention-days: 90
          compression-level: 9

      - name: Create artifact summary
        run: |
          echo "## FotaAgent and Dependencies Artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact Name**: fota-agent-dependencies-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Files**: $(wc -l < artifact_output/MANIFEST.txt)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Applications Included" >> $GITHUB_STEP_SUMMARY
          echo "1. **FotaAgent** (com.wsomacp) - OTA update management" >> $GITHUB_STEP_SUMMARY
          echo "2. **OmaCP** - OMA Client Provisioning" >> $GITHUB_STEP_SUMMARY
          echo "3. **AppUpdateCenter** (com.samsung.android.app.updatecenter) - App updates" >> $GITHUB_STEP_SUMMARY
          echo "4. **MCFDeviceSync** - Multi-Connect Framework sync" >> $GITHUB_STEP_SUMMARY
          echo "5. **NSDSWebApp** - Network Service Discovery" >> $GITHUB_STEP_SUMMARY
          echo "6. **SmartSwitchAssistant** (com.samsung.android.smartswitchassistant) - Data transfer" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Directory Structure" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cd artifact_output && tree -L 4 -d || find . -type d | sort | sed 's|^\./||' | grep -v '^\.$'
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Included" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat artifact_output/MANIFEST.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
