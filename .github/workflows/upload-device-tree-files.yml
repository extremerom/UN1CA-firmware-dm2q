name: Upload Device Tree Files from List

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/upload-device-tree-files.yml'

jobs:
  check-and-upload-files:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download file list
        run: |
          echo "Downloading file list from pa1q device tree..."
          curl -s https://raw.githubusercontent.com/Eduardob3677/android_device_samsung_pa1q/refs/heads/copilot/add-tree-command-output/tree_output.txt -o tree_output.txt
          
          # Verify the file is not empty and looks valid
          if [ ! -s tree_output.txt ]; then
            echo "Error: Downloaded file is empty"
            exit 1
          fi
          
          # Check it looks like a tree output (contains tree characters)
          if ! grep -q "â”œâ”€â”€\|â””â”€â”€" tree_output.txt; then
            echo "Error: File doesn't look like tree output"
            exit 1
          fi
          
          echo "âœ“ File list downloaded and validated"
          echo ""
          echo "Total lines in tree output: $(wc -l < tree_output.txt)"

      - name: Parse tree and search for files
        id: check_files
        run: |
          echo "Parsing tree structure and searching for files by name across repository..."
          
          python3 << 'EOFPYTHON'
          import os
          import re
          import subprocess
          
          def parse_tree_output(filename):
              """Parse tree output to extract file names."""
              with open(filename, 'r', encoding='utf-8') as f:
                  lines = f.readlines()
              
              file_names = set()
              
              for line in lines:
                  line = line.rstrip('\n\r')
                  if not line or 'directories,' in line or 'files' in line:
                      continue
                  if line.strip() == '.':
                      continue
                  
                  # Extract the name by removing tree characters
                  name = re.sub(r'[â”œâ””â”‚â”€\s]+', ' ', line).strip()
                  
                  if not name:
                      continue
                  
                  # Check if it's a file (has extension)
                  if '.' in name and name not in ['.', '..']:
                      file_names.add(name)
              
              return sorted(file_names)
          
          # Parse the tree to get all file names
          print("Parsing tree output to extract file names...")
          file_names = parse_tree_output('tree_output.txt')
          print(f"Total unique file names to search: {len(file_names)}")
          
          # Search for these files in the repository
          print("\nSearching for files by name across the entire repository...")
          found_files = {}  # filename -> list of paths where found
          missing_files = []
          
          for filename in file_names:
              # Sanitize filename - only allow safe characters
              if not re.match(r'^[a-zA-Z0-9._@+-]+$', filename):
                  print(f"Warning: Skipping unsafe filename: {filename}")
                  missing_files.append(filename)
                  continue
              
              # Use find to search for this filename
              result = subprocess.run(
                  ['find', '.', '-type', 'f', '-name', filename],
                  capture_output=True,
                  text=True
              )
              
              if result.returncode == 0 and result.stdout.strip():
                  paths = [p.lstrip('./') for p in result.stdout.strip().split('\n') if p.strip()]
                  # Filter out hidden directories like .git
                  paths = [p for p in paths if not p.startswith('.git/')]
                  if paths:
                      found_files[filename] = paths
                  else:
                      missing_files.append(filename)
              else:
                  missing_files.append(filename)
          
          print(f"\nFiles FOUND: {len(found_files)}")
          print(f"Files NOT FOUND: {len(missing_files)}")
          
          # Save detailed results
          with open('found_files_detail.txt', 'w') as f:
              for filename in sorted(found_files.keys()):
                  f.write(f"\n{filename}:\n")
                  for path in found_files[filename]:
                      f.write(f"  {path}\n")
          
          with open('missing_files.txt', 'w') as f:
              for filename in sorted(missing_files):
                  f.write(f"{filename}\n")
          
          # Create a flat list of all found file paths for artifact collection
          with open('found_files_paths.txt', 'w') as f:
              for filename, paths in sorted(found_files.items()):
                  for path in paths:
                      f.write(f"{path}\n")
          
          # Save counts for GitHub output
          with open('counts.txt', 'w') as f:
              f.write(f"total={len(file_names)}\n")
              f.write(f"found={len(found_files)}\n")
              f.write(f"missing={len(missing_files)}\n")
          
          # Print samples
          if found_files:
              print("\n=== FOUND files (first 30) ===")
              for i, (filename, paths) in enumerate(sorted(found_files.items())[:30], 1):
                  print(f"{i}. {filename} ({len(paths)} location(s))")
                  for path in paths[:2]:
                      print(f"   â†’ {path}")
                  if len(paths) > 2:
                      print(f"   ... and {len(paths) - 2} more")
          else:
              print("\nâš ï¸  No files from the list were found in this repository")
          
          if missing_files:
              print(f"\n=== MISSING files (first 20) ===")
              for i, f in enumerate(sorted(missing_files)[:20], 1):
                  print(f"{i}. {f}")
              
              if len(missing_files) > 20:
                  print(f"... and {len(missing_files) - 20} more")
          
          EOFPYTHON
          
          # Read counts safely
          total=$(grep '^total=' counts.txt | cut -d= -f2)
          found=$(grep '^found=' counts.txt | cut -d= -f2)
          missing=$(grep '^missing=' counts.txt | cut -d= -f2)
          
          # Validate the values are numbers
          if ! [[ "$total" =~ ^[0-9]+$ ]] || ! [[ "$found" =~ ^[0-9]+$ ]] || ! [[ "$missing" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid counts in counts.txt"
            exit 1
          fi
          
          echo "total_files=$total" >> $GITHUB_OUTPUT
          echo "found_files=$found" >> $GITHUB_OUTPUT
          echo "missing_files=$missing" >> $GITHUB_OUTPUT

      - name: Create artifact directory and copy found files
        if: steps.check_files.outputs.found_files > 0
        run: |
          echo "Creating artifact directory structure..."
          mkdir -p artifact_output
          
          # Copy found files preserving directory structure
          echo "Copying found files..."
          total=0
          while IFS= read -r file; do
            # Validate the file path doesn't contain directory traversal
            if [[ "$file" == *".."* ]]; then
              echo "âš  Skipping potentially unsafe path: $file"
              continue
            fi
            
            if [ -f "$file" ]; then
              # Create parent directory in artifact_output
              parent_dir=$(dirname "$file")
              
              # Additional validation of parent_dir
              if [[ "$parent_dir" == *".."* ]]; then
                echo "âš  Skipping unsafe parent dir: $parent_dir"
                continue
              fi
              
              mkdir -p "artifact_output/$parent_dir"
              
              # Copy the file
              cp "$file" "artifact_output/$file"
              total=$((total + 1))
              
              # Show progress for first 10 files
              if [ $total -le 10 ]; then
                echo "âœ“ Copied: $file"
              fi
            fi
          done < found_files_paths.txt
          
          echo ""
          echo "Total files copied: $total"

      - name: Create file report
        run: |
          echo "Creating detailed file report..."
          
          cat > FILE_REPORT.md << 'EOFREPORT'
          # Device Tree Files Report
          
          Este reporte muestra que archivos de la [lista del device tree pa1q](https://github.com/Eduardob3677/android_device_samsung_pa1q/tree/copilot/add-tree-command-output) fueron encontrados en este repositorio de firmware.
          
          ## Resumen
          
          - **Total de archivos en la lista**: ${{ steps.check_files.outputs.total_files }}
          - **Archivos encontrados**: ${{ steps.check_files.outputs.found_files }}
          - **Archivos faltantes**: ${{ steps.check_files.outputs.missing_files }}
          
          ## Archivos Encontrados
          
          EOFREPORT
          
          if [ -s found_files_detail.txt ]; then
            echo "Los siguientes archivos de la lista del device tree fueron encontrados en este repositorio:" >> FILE_REPORT.md
            echo "" >> FILE_REPORT.md
            echo "<details>" >> FILE_REPORT.md
            echo "<summary>Click para expandir la lista de archivos encontrados (${{ steps.check_files.outputs.found_files }} archivos)</summary>" >> FILE_REPORT.md
            echo "" >> FILE_REPORT.md
            echo '```' >> FILE_REPORT.md
            cat found_files_detail.txt >> FILE_REPORT.md
            echo '```' >> FILE_REPORT.md
            echo "</details>" >> FILE_REPORT.md
          else
            echo "âš ï¸ **No se encontraron archivos de la lista del device tree en este repositorio.**" >> FILE_REPORT.md
          fi
          
          echo "" >> FILE_REPORT.md
          echo "## Archivos Faltantes" >> FILE_REPORT.md
          echo "" >> FILE_REPORT.md
          
          if [ -s missing_files.txt ]; then
            echo "Los siguientes archivos de la lista del device tree NO fueron encontrados:" >> FILE_REPORT.md
            echo "" >> FILE_REPORT.md
            echo "<details>" >> FILE_REPORT.md
            echo "<summary>Click para expandir lista de archivos faltantes (${{ steps.check_files.outputs.missing_files }} archivos)</summary>" >> FILE_REPORT.md
            echo "" >> FILE_REPORT.md
            echo '```' >> FILE_REPORT.md
            cat missing_files.txt >> FILE_REPORT.md
            echo '```' >> FILE_REPORT.md
            echo "</details>" >> FILE_REPORT.md
          fi
          
          echo "" >> FILE_REPORT.md
          echo "## CategorÃ­as de Archivos Encontrados" >> FILE_REPORT.md
          echo "" >> FILE_REPORT.md
          echo "### MÃ³dulos del Kernel (.ko)" >> FILE_REPORT.md
          echo "Drivers y mÃ³dulos del kernel encontrados en:" >> FILE_REPORT.md
          echo "- \`recovery/root/lib/modules/\`" >> FILE_REPORT.md
          echo "- \`vendor_dlkm/lib/modules/\`" >> FILE_REPORT.md
          echo "- \`vendor_boot/root.1/lib/modules/\`" >> FILE_REPORT.md
          echo "" >> FILE_REPORT.md
          echo "### Bibliotecas Compartidas (.so)" >> FILE_REPORT.md
          echo "Bibliotecas del sistema y vendor encontradas en:" >> FILE_REPORT.md
          echo "- \`system/system/lib/\` y \`system/system/lib64/\`" >> FILE_REPORT.md
          echo "- \`vendor/lib/\` y \`vendor/lib64/\`" >> FILE_REPORT.md
          echo "- \`recovery/root/system/lib64/\`" >> FILE_REPORT.md
          echo "" >> FILE_REPORT.md
          echo "### Archivos de ConfiguraciÃ³n" >> FILE_REPORT.md
          echo "- Archivos XML (manifiestos, permisos, configuraciones)" >> FILE_REPORT.md
          echo "- Archivos RC (scripts de init)" >> FILE_REPORT.md
          echo "- Archivos PROP (propiedades del sistema)" >> FILE_REPORT.md
          echo "" >> FILE_REPORT.md
          echo "## Notas" >> FILE_REPORT.md
          echo "" >> FILE_REPORT.md
          echo "- La bÃºsqueda se realizÃ³ por **nombre de archivo** en todo el repositorio" >> FILE_REPORT.md
          echo "- Los archivos pueden estar en diferentes rutas que las especificadas en la lista original" >> FILE_REPORT.md
          echo "- Algunos archivos pueden aparecer en mÃºltiples ubicaciones (recovery, vendor, system)" >> FILE_REPORT.md
          echo "" >> FILE_REPORT.md
          echo "---" >> FILE_REPORT.md
          echo "" >> FILE_REPORT.md
          echo "*Generado por GitHub Actions workflow*" >> FILE_REPORT.md
          echo "*Fuente: [tree_output.txt](https://raw.githubusercontent.com/Eduardob3677/android_device_samsung_pa1q/refs/heads/copilot/add-tree-command-output/tree_output.txt)*" >> FILE_REPORT.md
          
          # Display the report
          echo ""
          echo "========================================"
          cat FILE_REPORT.md
          echo "========================================"

      - name: Upload found files as artifact
        if: steps.check_files.outputs.found_files > 0
        uses: actions/upload-artifact@v4
        with:
          name: device-tree-files-${{ github.sha }}
          path: artifact_output/
          retention-days: 30
          compression-level: 9

      - name: Upload file lists and report
        uses: actions/upload-artifact@v4
        with:
          name: device-tree-file-report-${{ github.sha }}
          path: |
            tree_output.txt
            found_files_detail.txt
            missing_files.txt
            FILE_REPORT.md
          retention-days: 90
          compression-level: 9

      - name: Create summary
        run: |
          echo "## ðŸ“‹ BÃºsqueda de Archivos del Device Tree Completada" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resumen" >> $GITHUB_STEP_SUMMARY
          echo "- **Total de archivos en la lista**: ${{ steps.check_files.outputs.total_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Archivos encontrados**: ${{ steps.check_files.outputs.found_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Archivos faltantes**: ${{ steps.check_files.outputs.missing_files }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_files.outputs.found_files }}" -gt "0" ]; then
            echo "### âœ… Archivos Encontrados" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Se encontraron **${{ steps.check_files.outputs.found_files }}** archivos de la lista del device tree." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Los archivos han sido subidos al artifact: \`device-tree-files-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Nota**: La bÃºsqueda se realizÃ³ por nombre de archivo en todo el repositorio." >> $GITHUB_STEP_SUMMARY
            echo "Los archivos pueden estar en rutas diferentes a las especificadas en la lista original." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Ejemplos de archivos encontrados:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -30 found_files_detail.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ No se Encontraron Archivos" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No se encontraron archivos de la lista del device tree en este repositorio de firmware." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ Reportes Disponibles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Un reporte detallado ha sido subido al artifact: \`device-tree-file-report-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "El reporte incluye:" >> $GITHUB_STEP_SUMMARY
          echo "- Lista completa de archivos encontrados con sus ubicaciones" >> $GITHUB_STEP_SUMMARY
          echo "- Lista completa de archivos faltantes" >> $GITHUB_STEP_SUMMARY
          echo "- CategorizaciÃ³n de archivos" >> $GITHUB_STEP_SUMMARY
          echo "- Salida original del Ã¡rbol de directorios" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow completado en $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
